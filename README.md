# 🚀 פרויקט שפת המדבר - מדריך שרת מקומי וסנכרון

מדריך זה מסביר כיצד להקים, לתפעל ולסנכרן את המערכת בעבודה מול שרת **Supabase מקומי**, המיועד לעבודה יציבה בבית הקפה ללא תלות באינטרנט.

---

## 🛠️ התקנה ראשונית (מחשב חדש / N150)

כדי להקים את המערכת מאפס על מחשב חדש:

1. **התקן Docker Desktop**: חובה להוריד ולהפעיל את Docker לפני הכל.
2. **הורד את הקוד**: בצע `git clone` או העתק את תיקיית הפרויקט.
3. **הרץ את סקריפט הסטאפ**:  
    פתח טרמינל בתיקיית הפרויקט והרצ:

    ```bash
    sh setup_local_server.sh
    ```

    *הסקריפט יתקין תלויות, ירים את המכולות של סופבייס ויבצע סנכרון ראשוני מהענן.*

---

## 🔄 מנגנוני סנכרון (Cloud ↔ Local)

המערכת עובדת במודל **Local-First** עם גיבוי בענן.

### 📥 משיכת נתונים מהענן למקומי (Mirroring)

אם עדכנת תפריטים או מחירים בענן ואתה רוצה "ליישר קו" במקומי:

```bash
node scripts/sync_cloud_to_local.js [BUSINESS_ID]
```

*(ברירת מחדל ל-Business ID: 222)*

### 📤 סנכרון הזמנות KDS

האפליקציה עצמה מבצעת סנכרון של הזמנות בזמן אמת. אם האינטרנט מתנתק, ההזמנות נשמרות ב-Dexie (DB מקומי בדפדפן) ומסתנכרנות לסופבייס ברגע שהחיבור חוזר.

---

## 🔌 עבודה ברשת המקומית (WiFi)

כדי שמכשירים אחרים (קופות, טאבלטים) יוכלו לגשת למחשב השרת:

1. **IP קבועה**: הגדר בראוטר IP סטטי למחשב השרת (למשל `192.168.1.150`).
2. **הגדרות סביבה**: בקובץ `.env.local`, עדכן את הכתובת:

    ```env
    VITE_LOCAL_SUPABASE_URL=http://192.168.1.150:54321
    ```

3. **ניתוב אוטומטי (Fallback)**: המערכת מתוכננת לנסות קודם את השרת המקומי. אם הוא לא זמין, היא תעבור אוטומטית לעבוד מול הענן כדי למנוע השבתה.

---

## 🌍 גישה מרחוק (Remote Access)

כדי לגשת לשרת המקומי מחוץ לרשת הביתית (למשל מהבית או מהטלפון בדרכים):

### 1. Tailscale (מומלץ ביותר)

הדרך הבטוחה והפשוטה ביותר. יוצרת רשת VPN פרטית בין המכשירים שלך.

* התקן Tailscale על מחשב השרת ועל המכשיר המרוחק.
* תקבל כתובת IP ייחודית (למשל `100.x.y.z`) שתעבוד מכל מקום בעולם כאילו אתה באותה רשת.

### 2. Cloudflare Tunnel

אם אתה רוצה כתובת URL קבועה (כמו `local-pos.yourdomain.com`):

* מאפשר לחשוף את פורט `54321` (API) ופורט `4028` (Web) החוצה בצורה מאובטחת ללא פתיחת פורטים בראוטר.

---

## 🚨 פתרון בעיות נפוצות

* **שגיאת "Connection Refused":** וודא ש-Docker רץ ושביצעת `npx supabase start`.
* **נתונים לא מסונכרנים:** הרץ את סקריפט ה-`sync_cloud_to_local.js` כדי למשוך מידע עדכני מהענן.
* **הקופה לא מוצאת את השרת:** וודא ששני המכשירים על אותו WiFi ושה-IP ב-env נכון.
